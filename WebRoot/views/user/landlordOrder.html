<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>我的房源 </title>
		<script src="../../js/comment.js"></script>
		<link rel="stylesheet" type="text/css" href="../../layui/css/layui.css">
		<script src="../../js/jquery.min.js"></script>
		<script src="../../layui/layui.all.js"></script>
		<script src="../../layui/layui.js"></script>
		<style type="text/css">
			#navId li a {
				font-size: 15px;
				color: white;
				font-weight: bold;
			}

			#rightNav {
				float: right;
			}

			#main {
				width: 1445px;
				height: 100%;
				margin-left: 220px;
				margin-top: 40px;
			}

			#main img {
				border-radius: 10px;
			}

			.foot {
				margin-top: 180px;
				width: 1090px;
				margin-left: 550px;
			}
		</style>
	</head>
	<body>
		<div id="top">
			<ul class="layui-nav layui-bg-green" id="navId">
				<li class="layui-nav-item">
					<a href="../index.html">
						<img src="../../img/logo.jpg" class="layui-nav-img">
					</a>
				</li>
				<li class="layui-nav-item ">
					<form class="layui-form" action="">
						<input id="topSearch" style=" width: 400px;height:48px; font-weight: bold; font-size: 20px; " name="search"
						 placeholder="搜一搜" autocomplete="off" class="layui-input">
					</form>
				</li>
				<div id="rightNav">
					<li class="layui-nav-item"><a href="">故事</a></li>
					<li class="layui-nav-item" style="cursor: pointer;"><a class="NavA" data-method="login">注册</a></li>
					<li class="layui-nav-item" style="cursor: pointer;"><a class="NavA" data-method="login">登录</a></li>
				</div>
			</ul>
		</div>
		<div id="main">
			<div id="">
				<div class="layui-col-xs12">
					<span style="font-size: 40px;color: gray;font-weight:bolder;">
						我的房源订单
					</span>
				</div><br><br><br><br><br><br>
				<div class="layui-tab" id="tab">
					<ul class="layui-tab-title">
						<li class="layui-this" id="capa1">未处理订单</li>
						<li id="capa2">已处理订单</li>
						<li id="capa3">已完成订单</li>
					</ul>
					<div class="layui-tab-content"><br><br><br>
						<div class="layui-tab-item layui-show" id="allOrder">
							<table class="layui-hide" id="test" lay-filter="test"></table>
						</div>
						<div class="layui-tab-item">
							<table class="layui-hide" id="test2" lay-filter="test"></table>
						</div>
						<div class="layui-tab-item">
							<table class="layui-hide" id="test3" lay-filter="test"></table>
						</div>
					</div>
				</div>
			</div><br><br><br><br>
		</div>
		<div class="foot">
			<div>
				<div>京ICP备16017121号-3 京ICP证 160773号
					<img src="https://z1.muscache.cn/airbnb/static/packages/public_security_bureau_logo.d0289dc0.png" alt="中国公安局标志">
					<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502032345" target="_blank" rel="noopener noreferrer"
					 aria-busy="false">京公网安备 11010502032345号</a>
					技术支持：卓应教育（湖南）有限公司 <a href="https://a0.muscache.com/pictures/03ec62da-f467-4e2b-bfee-6eefd052d7f5.jpg" target="_blank"
					 rel="noopener noreferrer" aria-busy="false">营业执照</a></div>
				<div dir="ltr">© 2019 Airbnb, Inc. All rights reserved.</div>
			</div>
			<br><br><br><br><br><br>
		</div>
		<script type="text/html" id="bar">
			<a class="layui-btn layui-btn-xs" lay-event="yes">确认订单</a>
		   <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="show">查看入住人信息</a>
		</script>
		<script type="text/javascript">
			//利用Cookie拿到信息
			// var userInfo=$.Cookie('userInfo');
			var userInfo = {
				user_id: '3',
				user_name: 'haku',
				user_img: '../img/timg.jpg',
				user_id: '1001',
				islanlord: 1
			};
				json = getCookie('userInfo');
				if (json != '' || json == null) {
					jsonInfo = JSON.parse(json);
					if (jsonInfo != null) {
						userInfo = jsonInfo;
						$("#myImg").attr("src","../../"+userInfo.user_headimg_url);
						console.log(userInfo);
					}
				}
				
				//初始化导航栏
				if (userInfo.user_id != null) {
					var html = '<li class="layui-nav-item " id="china"> <a href="myOrder.html" >房源订单中心</a></li>' +
						'<li class="layui-nav-item"><a href="../story/index.html">故事</a></li>' +
						'<li class="layui-nav-item"><a href="#" id="notice">消息<span id="dot" class="layui-badge-dot"></span></a> </li>' +
						' <li class="layui-nav-item" lay-unselect=""><a href="javascript:;"><img id="headImg" src="../../'+userInfo.user_headimg_url+'" class="layui-nav-img">' + userInfo.user_name + '</a> ' +
						'<dl class="layui-nav-child"><dd><a href="../host/landlord.html?user_id='+userInfo.user_id+'"  style="color: gray;">个人中心</a></dd>' +
						' <dd><a href="modifyInfo.html" style="color: gray;">修改信息</a></dd><dd><a href="../index.html" id="quit" style="color: gray;">退了</a></dd></dl>';
					$("#rightNav").empty();
					$("#rightNav").append(html);
					if (userInfo.islanlord != 1) {
						$("#china").after('<li class="layui-nav-item "> <a href="">我的房源</a>' +
							'<dl class="layui-nav-child"><dd><a href="landlordOrder.html"  style="color: gray;">订单信息</a></dd>' +
							' <dd><a href="myHouse.html" style="color: gray;">房源信息</a></dd></dl>' + '</li>' +
							'<li class="layui-nav-item "><a href="../host/create_a_room/room.html">添加房源</a></li>');
					} else {
						$("#china").after('<li class="layui-nav-item "> <a href="../host/create_a_room/become.html">成为房东</a></li>');
					}
				}
				//退出按钮监听
				$("body").on("click", "#quit", function() {
					setCookie("userInfo", null, 0.1);
				});
				
				//设置cookie
				function setCookie(cname, cvalue, exdays) {
				    var d = new Date();
				    d.setTime(d.getTime() + (exdays*24*60*60*1000));
				    var expires = "expires="+ d.toUTCString();
				    document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
				} 
				//获取Cookie
				function getCookie(cname) {
					var name = cname + "=";
					var decodedCookie = decodeURIComponent(document.cookie);
					var ca = decodedCookie.split(';');
					for (var i = 0; i < ca.length; i++) {
						var c = ca[i];
						while (c.charAt(0) == ' ') {
							c = c.substring(1);
						}
						if (c.indexOf(name) == 0) {
							return c.substring(name.length, c.length);
						}
					}
					return "";
				}
		</script>
		<script>
			layui.use(['table','element'], function() {
				var table = layui.table;
				table.render({
					elem: '#test',
					size: 'lg',
					url: basePath + "order.do?method=getUserInfoByLandlordID",
					where: {
						user_id: userInfo.user_id,
						state:1
					},
					dataType: "json",
					cols: [
						[{
							type: 'checkbox',
							fixed: 'left'
						},{
							field: 'house_name',
							title: '房源名称',
							width: 235,
							sort: true
						},{
							field: 'user_phone',
							title: '房客电话',
							width: 155,
							sort: true
						},  {
							field: 'user_name',
							title: '房客姓名',
							width: 110,
						}, {
							field: 'reserve_date',
							edit: 'text',
							title: ' 入住时间',
							width: 140
						}, {
							field: 'check_out_date',
							edit: 'text',
							title: '退房时间',
							width: 140
						}, {
							field: 'reserve_day_number',
							title: '天数',
							width: 120,
							sort: true
						}, {
							field: 'price',
							title: '金额',
							width: 120,
							sort: true
						}, {
							field: 'grogshop_order_state',
							title: '订单状态',
							width: 140,
							sort: true,
							edit: 'text'
						}, 
						{
							fixed: 'right',
							title: '操作',
							toolbar: '#bar',
							width: 205
						}]
					],
					page: true
				});
				$("#capa2").on("click",function() {
					getInfo('#test2',2)
				});
				$("#capa3").on("click",function() {
					getInfo('#test3',3)
				});
				function getInfo(myElem,myState) {
					table.render({
						elem: myElem,
						size: 'lg',
						url: basePath + "order.do?method=getUserInfoByLandlordID",
						where: {
							user_id: userInfo.user_id,
							state:myState
						},
						dataType: "json",
						cols: [
							[{
								type: 'checkbox',
								fixed: 'left'
							},{
								field: 'house_name',
								title: '房源名称',
								width: 250,
								sort: true
							},{
								field: 'real_name',
								title: '房客真实姓名',
								width: 105,
								sort: true
							},{
								field: 'user_phone',
								title: '房客电话',
								width: 150,
								sort: true
							},  {
								field: 'user_name',
								title: '房客姓名',
								width: 100,
							}, {
								field: 'reserve_date',
								edit: 'text',
								title: ' 入住时间',
								width: 120
							}, {
								field: 'check_out_date',
								edit: 'text',
								title: '退房时间',
								width: 120
							}, {
								field: 'reserve_day_number',
								title: '天数',
								width: 120,
								sort: true
							}, {
								field: 'price',
								title: '金额',
								width: 120,
								sort: true
							}, {
								field: 'grogshop_order_state',
								title: '订单状态',
								width: 120,
								sort: true,
								edit: 'text'
							}]
						],
						page: true
					});
				}
				//监听行工具事件
				table.on('tool(test)', function(obj) {
					var data = obj.data;
					//console.log(obj)
					if (obj.event === 'del') {
						layer.confirm('真的取消订单么', function(index) {
							console.log(data);
							$.getJSON(basePath + "order.do?method=updateOrder", {
								"order_id": data.grogshop_order_id,"landlordState":2
							}, function(res) {
								if(res.code > 0) {
									layer.msg("取消成功");
									
								}else {
									layer.msg("取消失败");
								}
								window.setTimeout (function() {
									layer.close(index);
								},3200);
							});
							
						});
					} else if (obj.event === 'yes') {
						$.getJSON(basePath + "order.do?method=updateOrder", {
							"order_id": data.grogshop_order_id,"state":2
						}, function(res) {
							if(res.code > 0) {
								layer.msg("确认成功");
								layer.alert("已确认！")
							}else {
								layer.msg("确认失败");
							}
							// window.setTimeout (function() {
							// 	layer.close(index);
							// },1200);
						});
						
					}else if(obj.event == 'show') {
						layer.alert()
					}
				});
				
			});
		</script>
	</body>
	
</html>
